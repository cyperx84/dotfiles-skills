---
name: SketchyBar Plugin Dev
description: >
  Activate when user says "create sketchybar plugin", "new bar widget", "debug sketchybar",
  "scaffold plugin", or wants to develop SketchyBar plugins. Automates plugin scaffolding,
  event subscriptions, data fetching patterns, error handling, and testing.
tools:
  - Bash
  - Read
  - Write
  - Glob
version: 1.0.0
author: Dotfiles Skills
---

# SketchyBar Plugin Dev Skill

## Purpose

The SketchyBar Plugin Dev skill streamlines the development of custom SketchyBar plugins. Creating a plugin manually requires understanding SketchyBar's event system, writing correct bash/lua scripts, setting up file permissions, integrating with the main config, and debugging when things don't work. This skill automates the entire workflow - from scaffolding to testing to deployment - so you can focus on the plugin logic rather than boilerplate and integration details.

## When to Use This Skill

Activate when the user:
- Wants to create a new SketchyBar plugin
- Needs to add a widget to their menu bar
- Is debugging an existing plugin that isn't working
- Wants to test a plugin in isolation
- Needs help integrating a plugin with SketchyBar
- Mentions keywords like: "create sketchybar plugin", "new bar widget", "menu bar item", "debug sketchybar", "test bar plugin"

## Workflow

### Phase 1: Plugin Planning & Scaffolding

**Gather Requirements**:

```
Ask user:
- Plugin name (e.g., "spotify", "weather", "docker-status")
- Plugin type:
  * Data display (show information)
  * Action trigger (clickable button)
  * Indicator (status icon)
  * Combined (data + action)
- Update frequency:
  * On-demand (when event occurs)
  * Periodic (every N seconds)
  * Both
- Data source:
  * CLI tool (e.g., spotify API, curl)
  * File watch (log file, config file)
  * System API (macOS APIs)
  * External service (API call)
```

**Choose Template**:

Based on plugin type, select appropriate template:

```bash
PLUGIN_NAME="$1"
PLUGIN_TYPE="$2"  # data|action|indicator|combined

case $PLUGIN_TYPE in
  data)
    TEMPLATE="data-display-template"
    # Simple plugin that shows information
    ;;
  action)
    TEMPLATE="action-button-template"
    # Clickable plugin that triggers action
    ;;
  indicator)
    TEMPLATE="status-indicator-template"
    # Icon/color that changes based on status
    ;;
  combined)
    TEMPLATE="combined-template"
    # Full-featured plugin with data + actions
    ;;
esac
```

**Scaffold Plugin Structure**:

```bash
SKETCHYBAR_DIR="$HOME/.config/sketchybar"
PLUGIN_DIR="$SKETCHYBAR_DIR/plugins"
PLUGIN_FILE="$PLUGIN_DIR/$PLUGIN_NAME.sh"

# Create plugin file from template
cat > "$PLUGIN_FILE" << 'EOF'
#!/usr/bin/env bash

# Plugin: ${PLUGIN_NAME}
# Description: ${PLUGIN_DESCRIPTION}
# Author: Auto-generated by SketchyBar Plugin Dev
# Created: $(date)

# Source helper functions
source "$HOME/.config/sketchybar/helpers/plugin_utils.sh"

# Configuration
UPDATE_FREQ=5  # Update every 5 seconds (adjust as needed)
ICON=""      # Default icon (customize)

# Main update function
update() {
  # TODO: Implement data fetching logic
  local data=$(fetch_data)

  # Update SketchyBar item
  sketchybar --set "$NAME" \
    label="$data" \
    icon="$ICON"
}

# Data fetching function
fetch_data() {
  # TODO: Implement actual data source
  # Example: spotify status, weather data, etc.
  echo "Plugin Active"
}

# Event handler for clicks
handle_click() {
  # TODO: Implement click action
  # Example: open app, toggle state, etc.
  echo "Clicked!"
}

# Handle script arguments
case "$SENDER" in
  "routine"|"forced")
    update
    ;;
  "mouse.clicked")
    handle_click
    ;;
esac
EOF

# Make executable
chmod +x "$PLUGIN_FILE"

echo "âœ… Plugin scaffolded: $PLUGIN_FILE"
```

**Create Helper Functions**:

```bash
# Create plugin-specific helper file
HELPER_FILE="$PLUGIN_DIR/helpers/${PLUGIN_NAME}_helpers.sh"

mkdir -p "$PLUGIN_DIR/helpers"

cat > "$HELPER_FILE" << 'EOF'
#!/usr/bin/env bash

# Helper functions for ${PLUGIN_NAME} plugin

# Error handling
log_error() {
  echo "[ERROR] $1" >&2
  # Optionally log to file
  echo "$(date): [ERROR] $1" >> "$HOME/.config/sketchybar/logs/${PLUGIN_NAME}.log"
}

# Rate limiting
should_update() {
  local last_update_file="/tmp/${PLUGIN_NAME}_last_update"
  local current_time=$(date +%s)

  if [ -f "$last_update_file" ]; then
    local last_update=$(cat "$last_update_file")
    local diff=$((current_time - last_update))

    if [ $diff -lt $UPDATE_FREQ ]; then
      return 1  # Too soon
    fi
  fi

  echo "$current_time" > "$last_update_file"
  return 0  # OK to update
}

# Data caching
get_cached_data() {
  local cache_file="/tmp/${PLUGIN_NAME}_cache"
  local cache_ttl=60  # 60 seconds

  if [ -f "$cache_file" ]; then
    local cache_age=$(($(date +%s) - $(stat -f%m "$cache_file")))
    if [ $cache_age -lt $cache_ttl ]; then
      cat "$cache_file"
      return 0
    fi
  fi

  return 1  # Cache miss
}

set_cached_data() {
  local cache_file="/tmp/${PLUGIN_NAME}_cache"
  echo "$1" > "$cache_file"
}
EOF

chmod +x "$HELPER_FILE"
```

### Phase 2: Event Subscription & Integration

**Add Plugin to SketchyBar Config**:

```bash
# Backup existing config
cp "$SKETCHYBAR_DIR/sketchybarrc" "$SKETCHYBAR_DIR/sketchybarrc.backup"

# Add plugin item definition
cat >> "$SKETCHYBAR_DIR/sketchybarrc" << EOF

# Plugin: ${PLUGIN_NAME}
sketchybar --add item $PLUGIN_NAME right \\
           --set $PLUGIN_NAME \\
                 update_freq=$UPDATE_FREQ \\
                 script="$PLUGIN_FILE" \\
                 icon="$ICON" \\
                 icon.color=\$ICON_COLOR \\
                 label.color=\$LABEL_COLOR \\
                 background.color=\$BG_COLOR \\
                 click_script="$PLUGIN_FILE" \\
           --subscribe $PLUGIN_NAME \\
                 system_woke \\
                 front_app_switched
EOF

echo "âœ… Plugin added to sketchybarrc"
```

**Set Up Event Subscriptions**:

Based on plugin requirements, subscribe to relevant events:

```bash
# Common SketchyBar events
EVENTS=(
  "system_woke"           # System wakes from sleep
  "front_app_switched"    # Active app changed
  "space_change"          # Desktop space changed
  "display_change"        # Monitor configuration changed
  "wifi_change"           # WiFi status changed
  "volume_change"         # System volume changed
  "brightness_change"     # Display brightness changed
)

# Plugin-specific custom events
CUSTOM_EVENTS=(
  "${PLUGIN_NAME}.update"   # Manual trigger
  "${PLUGIN_NAME}.refresh"  # Forced refresh
  "${PLUGIN_NAME}.toggle"   # Toggle state
)

# Add subscriptions to config
for event in "${EVENTS[@]}" "${CUSTOM_EVENTS[@]}"; do
  echo "  --subscribe $PLUGIN_NAME $event \\" >> "$SKETCHYBAR_DIR/sketchybarrc"
done
```

### Phase 3: Data Fetching Implementation

**Implement Data Source Logic**:

Guide user to implement data fetching based on source type:

**CLI Tool Data Source**:

```bash
fetch_data_cli() {
  local command="$1"

  # Execute command with timeout
  local output=$(timeout 2s $command 2>&1)
  local exit_code=$?

  if [ $exit_code -eq 0 ]; then
    echo "$output"
    return 0
  else
    log_error "Command failed: $command (exit code: $exit_code)"
    return 1
  fi
}

# Example: Spotify now playing
fetch_spotify_data() {
  fetch_data_cli "osascript -e 'tell application \"Spotify\" to name of current track'"
}
```

**API Data Source**:

```bash
fetch_data_api() {
  local api_url="$1"
  local api_key="$2"

  # Make API request with timeout
  local response=$(curl -sf \
    --max-time 3 \
    -H "Authorization: Bearer $api_key" \
    "$api_url" 2>&1)

  local exit_code=$?

  if [ $exit_code -eq 0 ]; then
    echo "$response" | jq -r '.data.value' 2>/dev/null || echo "Parse error"
    return 0
  else
    log_error "API request failed: $api_url"
    return 1
  fi
}

# Example: Weather API
fetch_weather_data() {
  local api_key="$WEATHER_API_KEY"
  local city="San Francisco"

  fetch_data_api \
    "https://api.openweathermap.org/data/2.5/weather?q=$city&appid=$api_key" \
    "$api_key"
}
```

**File Watch Data Source**:

```bash
watch_file_changes() {
  local file_to_watch="$1"
  local last_modified=0

  # Check if file modified
  if [ -f "$file_to_watch" ]; then
    local current_modified=$(stat -f%m "$file_to_watch")

    if [ $current_modified -gt $last_modified ]; then
      last_modified=$current_modified
      cat "$file_to_watch"
      return 0
    fi
  fi

  return 1  # No changes
}
```

**Error Handling & Fallbacks**:

```bash
update_with_fallback() {
  # Try primary data source
  local data=$(fetch_primary_source)

  if [ $? -ne 0 ] || [ -z "$data" ]; then
    # Fallback to cached data
    data=$(get_cached_data)

    if [ $? -ne 0 ]; then
      # Last resort: show error state
      data="âš ï¸ Unavailable"
    fi
  else
    # Cache successful fetch
    set_cached_data "$data"
  fi

  # Update display
  sketchybar --set "$NAME" label="$data"
}
```

### Phase 4: Testing & Debugging

**Create Test Script**:

```bash
TEST_SCRIPT="$PLUGIN_DIR/tests/test_${PLUGIN_NAME}.sh"

mkdir -p "$PLUGIN_DIR/tests"

cat > "$TEST_SCRIPT" << 'EOF'
#!/usr/bin/env bash

# Test script for ${PLUGIN_NAME} plugin

PLUGIN_FILE="$HOME/.config/sketchybar/plugins/${PLUGIN_NAME}.sh"

echo "ðŸ§ª Testing ${PLUGIN_NAME} plugin..."

# Test 1: Plugin file exists and is executable
test_file_exists() {
  if [ -x "$PLUGIN_FILE" ]; then
    echo "âœ… Plugin file exists and is executable"
    return 0
  else
    echo "âŒ Plugin file missing or not executable"
    return 1
  fi
}

# Test 2: Plugin can fetch data
test_data_fetch() {
  echo "Testing data fetch..."

  # Source the plugin to access its functions
  source "$PLUGIN_FILE"

  local data=$(fetch_data 2>&1)
  local exit_code=$?

  if [ $exit_code -eq 0 ] && [ -n "$data" ]; then
    echo "âœ… Data fetch successful: $data"
    return 0
  else
    echo "âŒ Data fetch failed (exit code: $exit_code)"
    return 1
  fi
}

# Test 3: Plugin updates SketchyBar
test_sketchybar_update() {
  echo "Testing SketchyBar update..."

  # Trigger plugin update
  NAME="${PLUGIN_NAME}" SENDER="forced" "$PLUGIN_FILE"

  if [ $? -eq 0 ]; then
    echo "âœ… SketchyBar update successful"
    return 0
  else
    echo "âŒ SketchyBar update failed"
    return 1
  fi
}

# Test 4: Click handler works
test_click_handler() {
  echo "Testing click handler..."

  NAME="${PLUGIN_NAME}" SENDER="mouse.clicked" "$PLUGIN_FILE"

  if [ $? -eq 0 ]; then
    echo "âœ… Click handler successful"
    return 0
  else
    echo "âŒ Click handler failed"
    return 1
  fi
}

# Run all tests
TESTS_PASSED=0
TESTS_FAILED=0

run_test() {
  if $1; then
    ((TESTS_PASSED++))
  else
    ((TESTS_FAILED++))
  fi
}

run_test test_file_exists
run_test test_data_fetch
run_test test_sketchybar_update
run_test test_click_handler

# Summary
echo ""
echo "ðŸ“Š Test Summary:"
echo "âœ… Passed: $TESTS_PASSED"
echo "âŒ Failed: $TESTS_FAILED"

if [ $TESTS_FAILED -eq 0 ]; then
  echo "ðŸŽ‰ All tests passed!"
  exit 0
else
  echo "âš ï¸ Some tests failed - review output above"
  exit 1
fi
EOF

chmod +x "$TEST_SCRIPT"

echo "âœ… Test script created: $TEST_SCRIPT"
```

**Debug Mode**:

```bash
# Add debug mode to plugin
DEBUG_MODE="${DEBUG_MODE:-false}"

debug_log() {
  if [ "$DEBUG_MODE" = "true" ]; then
    echo "[DEBUG] $1" >> "$HOME/.config/sketchybar/logs/${PLUGIN_NAME}-debug.log"
  fi
}

# Run with debug mode
DEBUG_MODE=true SENDER="forced" NAME="${PLUGIN_NAME}" $PLUGIN_FILE
```

**Interactive Testing**:

```bash
# Create interactive test REPL
test_plugin_interactive() {
  echo "ðŸ”§ Interactive Plugin Tester"
  echo "Commands: update, click, event <name>, debug, quit"

  while true; do
    read -p "> " command args

    case "$command" in
      update)
        echo "Triggering update..."
        NAME="${PLUGIN_NAME}" SENDER="forced" "$PLUGIN_FILE"
        ;;
      click)
        echo "Simulating click..."
        NAME="${PLUGIN_NAME}" SENDER="mouse.clicked" "$PLUGIN_FILE"
        ;;
      event)
        echo "Triggering event: $args"
        sketchybar --trigger "$args"
        ;;
      debug)
        echo "Enabling debug mode..."
        DEBUG_MODE=true NAME="${PLUGIN_NAME}" SENDER="forced" "$PLUGIN_FILE"
        ;;
      quit)
        break
        ;;
      *)
        echo "Unknown command: $command"
        ;;
    esac
  done
}
```

### Phase 5: Integration & Deployment

**Validate Integration**:

```bash
# Check that plugin is properly integrated
validate_integration() {
  echo "ðŸ” Validating plugin integration..."

  # 1. Check plugin in SketchyBar config
  if grep -q "$PLUGIN_NAME" "$SKETCHYBAR_DIR/sketchybarrc"; then
    echo "âœ… Plugin found in sketchybarrc"
  else
    echo "âŒ Plugin not in sketchybarrc"
    return 1
  fi

  # 2. Check SketchyBar can see the plugin
  if sketchybar --query "$PLUGIN_NAME" >/dev/null 2>&1; then
    echo "âœ… SketchyBar recognizes plugin"
  else
    echo "âŒ SketchyBar doesn't recognize plugin"
    return 1
  fi

  # 3. Verify plugin is updating
  local before=$(sketchybar --query "$PLUGIN_NAME" | jq -r '.label.value')
  sketchybar --trigger "${PLUGIN_NAME}.update"
  sleep 1
  local after=$(sketchybar --query "$PLUGIN_NAME" | jq -r '.label.value')

  if [ "$before" != "$after" ] || [ -n "$after" ]; then
    echo "âœ… Plugin is updating"
  else
    echo "âš ï¸ Plugin may not be updating properly"
  fi

  return 0
}
```

**Deploy Plugin**:

```bash
# Reload SketchyBar to activate plugin
deploy_plugin() {
  echo "ðŸš€ Deploying plugin..."

  # 1. Validate first
  if ! validate_integration; then
    echo "âŒ Validation failed - fix issues before deploying"
    return 1
  fi

  # 2. Reload SketchyBar
  echo "Reloading SketchyBar..."
  sketchybar --reload

  # 3. Wait for SketchyBar to stabilize
  sleep 2

  # 4. Trigger initial update
  sketchybar --trigger "${PLUGIN_NAME}.update"

  # 5. Verify plugin is visible
  if sketchybar --query "$PLUGIN_NAME" >/dev/null 2>&1; then
    echo "âœ… Plugin deployed and active!"

    # Show plugin info
    echo ""
    echo "ðŸ“Š Plugin Status:"
    sketchybar --query "$PLUGIN_NAME" | jq '{
      position,
      icon: .icon.value,
      label: .label.value,
      drawing: .drawing
    }'

    return 0
  else
    echo "âŒ Plugin deployment failed"
    return 1
  fi
}
```

### Phase 6: Documentation & Reporting

**Generate Plugin Documentation**:

```bash
cat > "$PLUGIN_DIR/docs/${PLUGIN_NAME}.md" << 'EOF'
# ${PLUGIN_NAME} Plugin

## Description
${PLUGIN_DESCRIPTION}

## Features
- ${FEATURE_1}
- ${FEATURE_2}
- ${FEATURE_3}

## Configuration

### Environment Variables
```bash
export ${PLUGIN_NAME_UPPER}_UPDATE_FREQ=5
export ${PLUGIN_NAME_UPPER}_ICON=""
```

### SketchyBar Config
Located in `~/.config/sketchybar/sketchybarrc`:
```bash
sketchybar --add item ${PLUGIN_NAME} right \\
           --set ${PLUGIN_NAME} \\
                 update_freq=$UPDATE_FREQ \\
                 script="$PLUGIN_FILE"
```

## Events

### Subscribed Events
- `system_woke` - Updates when system wakes
- `${PLUGIN_NAME}.update` - Manual update trigger
- `${PLUGIN_NAME}.refresh` - Force refresh

### Custom Events
Trigger manually:
```bash
sketchybar --trigger ${PLUGIN_NAME}.update
```

## Testing

Run test suite:
```bash
~/.config/sketchybar/plugins/tests/test_${PLUGIN_NAME}.sh
```

Debug mode:
```bash
DEBUG_MODE=true SENDER="forced" NAME="${PLUGIN_NAME}" ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh
```

## Troubleshooting

### Plugin Not Updating
```bash
# Check if plugin is loaded
sketchybar --query ${PLUGIN_NAME}

# Manually trigger update
sketchybar --trigger ${PLUGIN_NAME}.update

# Check logs
tail -f ~/.config/sketchybar/logs/${PLUGIN_NAME}.log
```

### Data Fetch Failing
```bash
# Test data source directly
source ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh
fetch_data
```

## Related Plugins
- Plugin A - Similar functionality
- Plugin B - Complementary feature

## Version History
- v1.0.0 - Initial release
EOF
```

**Success Report**:

```
ðŸŽ‰ SketchyBar Plugin Created Successfully!

ðŸ“Š Plugin Details:
Name: ${PLUGIN_NAME}
Type: ${PLUGIN_TYPE}
Location: ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh

âœ… Files Created:
- Plugin script: ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh
- Helper functions: ~/.config/sketchybar/plugins/helpers/${PLUGIN_NAME}_helpers.sh
- Test script: ~/.config/sketchybar/plugins/tests/test_${PLUGIN_NAME}.sh
- Documentation: ~/.config/sketchybar/plugins/docs/${PLUGIN_NAME}.md

ðŸ“ Integration:
âœ… Added to sketchybarrc
âœ… Event subscriptions configured
âœ… SketchyBar reloaded

ðŸ§ª Next Steps:
1. Test the plugin: ~/.config/sketchybar/plugins/tests/test_${PLUGIN_NAME}.sh
2. Customize the logic in fetch_data()
3. Add click handler in handle_click()
4. Adjust update frequency as needed

ðŸ“š Documentation: ~/.config/sketchybar/plugins/docs/${PLUGIN_NAME}.md

ðŸ’¡ Trigger manual update: sketchybar --trigger ${PLUGIN_NAME}.update
ðŸ’¡ Debug mode: DEBUG_MODE=true SENDER="forced" NAME="${PLUGIN_NAME}" ...

â±ï¸ Total time: ${ELAPSED_TIME} seconds
```

## Examples

### Example 1: Create Simple Data Display Plugin

**User**: "Create a SketchyBar plugin to show current Spotify track"

**Skill Actions**:
```
1. Gather requirements:
   - Name: spotify
   - Type: data display
   - Update: on track change
   - Source: AppleScript (Spotify API)

2. Scaffold plugin:
   âœ… Created spotify.sh
   âœ… Added helper functions
   âœ… Created test script

3. Implement data fetch:
   - osascript to get Spotify track name
   - Timeout handling (2s)
   - Error fallback ("Not Playing")

4. Add to sketchybarrc:
   - Item position: right
   - Update freq: event-based
   - Subscribe to: spotify_change (custom event)

5. Test plugin:
   âœ… File exists and executable
   âœ… Data fetch works
   âœ… SketchyBar update works
   âœ… All tests pass

6. Deploy:
   âœ… SketchyBar reloaded
   âœ… Plugin visible and updating

Result: Working Spotify plugin in 30 seconds
```

### Example 2: Debug Existing Plugin

**User**: "My weather plugin isn't updating"

**Skill Actions**:
```
1. Analyze plugin:
   - Read weather.sh
   - Check event subscriptions
   - Review error logs

2. Identify issues:
   âŒ API key missing
   âŒ curl timeout too short (1s)
   âš ï¸ No error handling

3. Fix issues:
   âœ… Added API key check with helpful error
   âœ… Increased timeout to 5s
   âœ… Added error logging
   âœ… Added cached data fallback

4. Test fixes:
   âœ… Data fetch now works
   âœ… Error handling prevents crashes
   âœ… Fallback shows cached data during API outage

5. Result:
   âœ… Plugin working reliably
   ðŸ“Š Added monitoring for API failures
```

### Example 3: Create Combined Plugin (Data + Action)

**User**: "Create plugin showing Docker container count with click to open Docker Desktop"

**Skill Actions**:
```
1. Requirements:
   - Name: docker-status
   - Type: combined (data + action)
   - Update: every 10 seconds
   - Source: docker ps command
   - Action: open Docker Desktop

2. Scaffold with combined template:
   âœ… Data display function
   âœ… Click handler function
   âœ… Both integrated in single script

3. Implement features:
   Data: docker ps -q | wc -l (count containers)
   Icon: ðŸ³ (changes color based on count)
   Click: open -a "Docker Desktop"

4. Add intelligence:
   - Green icon: containers running
   - Gray icon: no containers
   - Red icon: Docker daemon not running

5. Test:
   âœ… Shows correct container count
   âœ… Click opens Docker Desktop
   âœ… Icon color changes appropriately

6. Deploy:
   âœ… Active in menu bar
   âœ… Updates every 10s
   âœ… Click action works

Result: Professional Docker status widget
```

## Guidelines

### DO:
âœ… Start from templates for consistency
âœ… Add comprehensive error handling
âœ… Implement data caching to reduce load
âœ… Use timeouts for all external calls
âœ… Test plugins before deploying
âœ… Document configuration options
âœ… Provide debug logging mode
âœ… Handle missing dependencies gracefully
âœ… Subscribe to relevant events only
âœ… Make plugins configurable via environment variables
âœ… Include uninstall instructions

### DON'T:
âŒ Skip error handling (will crash SketchyBar)
âŒ Make blocking calls without timeout
âŒ Update too frequently (causes performance issues)
âŒ Hardcode configuration values
âŒ Ignore exit codes from external commands
âŒ Deploy without testing first
âŒ Create plugins with security vulnerabilities (API keys in code)
âŒ Assume external tools are installed
âŒ Use excessive CPU/memory
âŒ Leave debug logging on in production

## Advanced Features

### Dynamic Icon/Color Based on State

```bash
update_with_state_colors() {
  local value=$1
  local icon=""
  local icon_color=""

  if [ $value -gt 80 ]; then
    icon="ðŸ”´"
    icon_color="0xffff0000"  # Red
  elif [ $value -gt 50 ]; then
    icon="ðŸŸ¡"
    icon_color="0xffffff00"  # Yellow
  else
    icon="ðŸŸ¢"
    icon_color="0xff00ff00"  # Green
  fi

  sketchybar --set "$NAME" icon="$icon" icon.color="$icon_color"
}
```

### Popup Menus on Click

```bash
handle_click_with_menu() {
  # Create temporary popup script
  POPUP_SCRIPT="/tmp/${PLUGIN_NAME}_popup.sh"

  cat > "$POPUP_SCRIPT" << 'EOF'
#!/usr/bin/env bash
sketchybar --add item popup.title popup \\
           --set popup.title label="Options:" \\
           --add item popup.option1 popup \\
           --set popup.option1 label="Refresh" click_script="sketchybar --trigger ${PLUGIN_NAME}.refresh" \\
           --add item popup.option2 popup \\
           --set popup.option2 label="Settings" click_script="open ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh"
EOF

  chmod +x "$POPUP_SCRIPT"
  "$POPUP_SCRIPT"
}
```

### Multi-Source Data Aggregation

```bash
fetch_aggregated_data() {
  local source1=$(fetch_primary_source)
  local source2=$(fetch_secondary_source)

  # Combine data
  local combined="${source1} | ${source2}"

  echo "$combined"
}
```

## Dependencies

### Required
- **SketchyBar** - `brew install sketchybar`
  - Menu bar application

- **jq** - `brew install jq`
  - JSON parsing for plugin queries

### Highly Recommended
- **shellcheck** - `brew install shellcheck`
  - Validate plugin scripts

- **bash 4+** - `brew install bash`
  - Modern bash features

### Optional (Plugin-Specific)
Depends on what the plugin does:

```bash
# For weather plugins
brew install curl jq

# For Spotify plugins
# (Spotify app must be installed)

# For system stats plugins
brew install htop iostat

# For Docker plugins
brew install --cask docker
```

## Configuration

### Plugin Directory Structure

```
~/.config/sketchybar/
â”œâ”€â”€ sketchybarrc              # Main config
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ plugin1.sh            # Plugin scripts
â”‚   â”œâ”€â”€ plugin2.sh
â”‚   â”œâ”€â”€ helpers/              # Shared helpers
â”‚   â”‚   â”œâ”€â”€ plugin_utils.sh
â”‚   â”‚   â””â”€â”€ plugin1_helpers.sh
â”‚   â”œâ”€â”€ tests/                # Test scripts
â”‚   â”‚   â”œâ”€â”€ test_plugin1.sh
â”‚   â”‚   â””â”€â”€ test_plugin2.sh
â”‚   â””â”€â”€ docs/                 # Documentation
â”‚       â”œâ”€â”€ plugin1.md
â”‚       â””â”€â”€ plugin2.md
â””â”€â”€ logs/                     # Plugin logs
    â”œâ”€â”€ plugin1.log
    â””â”€â”€ plugin1-debug.log
```

## Troubleshooting

### "Plugin not showing up"
```bash
# Check if SketchyBar sees it
sketchybar --query ${PLUGIN_NAME}

# Check sketchybarrc syntax
cat ~/.config/sketchybar/sketchybarrc | grep ${PLUGIN_NAME}

# Reload SketchyBar
sketchybar --reload
```

### "Plugin crashes SketchyBar"
```bash
# Check plugin errors
bash -n ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh

# Run shellcheck
shellcheck ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh

# Test in isolation
DEBUG_MODE=true SENDER="forced" NAME="${PLUGIN_NAME}" ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh
```

### "Data not updating"
```bash
# Check update frequency
sketchybar --query ${PLUGIN_NAME} | jq '.update_freq'

# Manually trigger
sketchybar --trigger ${PLUGIN_NAME}.update

# Check if data source works
source ~/.config/sketchybar/plugins/${PLUGIN_NAME}.sh
fetch_data
```

## Success Metrics

A successful plugin development includes:
- âœ… Plugin file created and executable
- âœ… Integrated into sketchybarrc
- âœ… All tests passing
- âœ… Error handling implemented
- âœ… Data fetching working
- âœ… SketchyBar recognizes plugin
- âœ… Plugin visible in menu bar
- âœ… Updates at correct frequency
- âœ… Click actions working (if applicable)
- âœ… Documentation generated

## Integration

Works seamlessly with:
- **[Service Orchestrator](../service-orchestrator/)** - Reloads SketchyBar after plugin changes
- **[Pre-Commit Guardian](../pre-commit-guardian/)** - Validates plugin scripts before commit
- **[Theme Switcher](../theme-switcher/)** - Updates plugin colors with theme changes

## Version History

- v1.0.0 (2025-10-30): Initial production release
  - Plugin scaffolding from templates
  - Event subscription setup
  - Data fetching patterns
  - Error handling and logging
  - Test suite generation
  - Integration automation
  - Documentation generation
